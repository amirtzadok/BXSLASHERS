<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BX SLASHERS - Mobile Edition</title>
    <link rel="icon" type="image/png" href="icon.png">
    <meta http-equiv="Permissions-Policy" content="camera=(self)">

    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: #000; font-family: 'Arial Black', sans-serif; color: white; text-align: center; touch-action: none; }
        
        #fallback-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: url('bg.png') no-repeat center center; background-size: cover; z-index: 0; display: block; }
        #video-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: 1; transform: scaleX(-1); display: none; background: black; }
        #game-container { position: relative; width: 100vw; height: 100vh; z-index: 10; display: none; }
        
        /* 住 驻转 转  */
        #start-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #111; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 2000; padding: 10px; box-sizing: border-box; }
        
        /* 住专 -3 砖专转 */
        #character-row { 
            display: grid; 
            grid-template-columns: repeat(5, 1fr); /* 5 注 爪专 驻专住 专 */
            gap: 15px; 
            width: 95%; 
            max-height: 40vh; 
            overflow-y: auto; 
            padding: 15px;
            margin-bottom: 20px;
            justify-items: center;
        }
        
        .char-preview { 
            width: 75px; height: 75px; /* 转 注 */
            border-radius: 50%; background-size: cover; 
            border: 4px solid #fff; position: relative; cursor: pointer; transition: transform 0.2s;
        }
        .char-preview.selected { border: 6px solid #00ff00; transform: scale(1.1); box-shadow: 0 0 20px #00ff00; }
        
        .delete-btn { position: absolute; top: -5px; right: -5px; background: red; color: white; border-radius: 50%; width: 22px; height: 22px; font-size: 14px; cursor: pointer; border: none; display: flex; justify-content: center; align-items: center; }
        
        /* 驻转专   */
        .main-btn { padding: 25px 40px; font-size: 28px; cursor: pointer; color: white; border: none; border-radius: 20px; font-weight: bold; transition: 0.3s; width: 85%; max-width: 400px; margin-top: 10px; }
        #start-button { background: #ff0000; box-shadow: 0 0 25px #ff0000; text-transform: uppercase; }
        
        /* 驻转专 爪 -  砖 */
        .side-btn { position: fixed; z-index: 3000; background: rgba(0,0,0,0.8); border: 3px solid white; color: white; cursor: pointer; font-weight: bold; }
        #mute-btn { top: 20px; right: 20px; border-radius: 50%; width: 70px; height: 70px; font-size: 30px; }
        #early-end-btn { top: 20px; left: 20px; border-radius: 15px; padding: 15px 20px; font-size: 18px; }
        #toggle-cam-btn { top: 100px; left: 20px; border-radius: 15px; padding: 15px 20px; font-size: 16px; background: rgba(50, 50, 50, 0.9); }

        .target { position: absolute; width: 120px; height: 120px; border-radius: 50%; background-size: cover; border: 4px solid white; z-index: 20; }
        .particle { position: absolute; width: 10px; height: 10px; background: #ff0000; pointer-events: none; z-index: 60; }
        
        .stat-box { font-size: 20px; background: rgba(0,0,0,0.8); padding: 12px 18px; border-radius: 15px; border: 2px solid #ff0000; }
        #round-announcer { position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%); font-size: 90px; color: #ff0000; z-index: 500; display: none; text-shadow: 0 0 30px black; font-weight: bold; width: 100%; text-align: center; }

        #end-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 4000; padding: 20px; box-sizing: border-box; }
        #most-hit-img { width: 160px; height: 160px; border-radius: 50%; border: 6px solid #ff0000; margin: 15px 0; background-size: cover; }
    </style>
</head>
<body>

<audio id="bg-music" src="Final Girl Glitch.mp3" preload="auto"></audio>
<div id="fallback-bg"></div>
<video id="video-bg" autoplay playsinline muted webkit-playsinline></video>
<canvas id="motion-canvas" style="display:none;"></canvas>

<button id="mute-btn" class="side-btn" style="display:none;"></button>
<button id="early-end-btn" class="side-btn" style="display:none;">END GAME</button>
<button id="toggle-cam-btn" class="side-btn" style="display:none;">CAM OFF</button>

<div id="round-announcer">3</div>

<div id="start-screen">
    <h1 style="font-size: 55px; color: #ff0000; text-shadow: 3px 3px #fff; margin: 0;">BX SLASHERS</h1>
    <h2 style="font-size: 22px; color: #fff; margin: 10px 0;">CHOOSE YOUR SLASHER</h2>
    <div id="character-row"></div>
    <button id="start-button" class="main-btn">START GAME</button>
    <button onclick="document.getElementById('upload-modal').style.display='block'" style="background:none; border:none; color:#aaa; text-decoration:underline; cursor:pointer; font-size: 18px; margin-top: 15px;">+ Add Slasher</button>
</div>

<div id="upload-modal" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #222; padding: 30px; border-radius: 20px; border: 3px solid #ff0000; display: none; z-index: 5000; width: 80%;">
    <h3>ADD SLASHER</h3>
    <input type="text" id="new-name" placeholder="Name..." style="display:block; width:100%; margin-bottom:15px; padding:15px; font-size:18px;">
    <input type="file" id="new-file" accept="image/*" style="display:block; margin-bottom:20px; font-size:16px;">
    <button onclick="saveNewCharacter()" style="background:red; color:white; padding:15px 30px; border:none; cursor:pointer; font-weight:bold; font-size:20px; width:100%;">SAVE</button>
    <button onclick="document.getElementById('upload-modal').style.display='none'" style="background:#555; color:white; padding:10px; border:none; cursor:pointer; margin-top:10px; width:100%;">CANCEL</button>
</div>

<div id="game-container">
    <div id="ui-layer" style="position: absolute; bottom: 40px; width: 100%; display: flex; justify-content: space-around; pointer-events: none;">
        <div class="stat-box">Score: <span id="score-board">0</span></div>
        <div class="stat-box">Time: <span id="timer">60</span></div>
    </div>
</div>

<div id="end-screen">
    <h1 style="font-size: 45px; color: #ff0000; margin: 0;">BX SLASHERS</h1>
    <div id="most-hit-img"></div>
    <p id="most-hit-text" style="font-size: 18px; line-height: 1.3; color: #ddd; padding: 0 10px;"></p>
    <p id="self-kill-text" style="font-size: 20px; color: #ff0000; font-weight: bold; margin: 10px 0;"></p>
    <h2 id="final-total-score" style="font-size: 30px; color: #fff;"></h2>
    <button onclick="location.reload()" class="main-btn" style="padding: 20px; font-size: 22px;">PLAY AGAIN</button>
    <button id="whatsapp-share" class="main-btn" style="background:#25D366; padding: 20px; font-size: 22px;">SHARE </button>
</div>

<script>
    const gameUrl = window.location.href;
    let characters = [{name:'ella', url:'ella.png', bonus:true}, {name:'amir', url:'amir.png', bonus:false}, {name:'elad', url:'elad.png', bonus:true}, {name:'shay', url:'shay.png', bonus:false}, {name:'achinoam', url:'achinoam.png', bonus:false}, {name:'einat', url:'einat.png', bonus:false}, {name:'doron', url:'doron.png', bonus:true}, {name:'hadas', url:'hadas.png', bonus:false}, {name:'adi', url:'adi.png', bonus:true}, {name:'idan', url:'idan.png', bonus:true}, {name:'shoval', url:'shoval.png', bonus:false}, {name:'stas', url:'stas.png', bonus:false}, {name:'vik', url:'vik.png', bonus:false}, {name:'vivi', url:'vivi.png', bonus:false}];
    
    let hitCount = {};
    let score = 0, totalTime = 60, songElapsed = 0, gameActive = false, currentRound = 0, prevFrameData = null;
    let spawnRate = 1200, moveDuration = 4000, mainInterval;
    let selectedSlasher = 'amir';
    let selfKills = 0;
    let cameraActive = false;
    
    const video = document.getElementById('video-bg'), canvas = document.getElementById('motion-canvas'), ctx = canvas.getContext('2d'), bgMusic = document.getElementById('bg-music');

    document.getElementById('toggle-cam-btn').onclick = function() {
        if (!video.srcObject) { startCamera(); } 
        else { cameraActive = !cameraActive; video.style.display = cameraActive ? 'block' : 'none'; this.innerText = cameraActive ? 'CAM OFF' : 'CAM ON'; }
    };

    async function startCamera() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: { width: { ideal: 640 }, height: { ideal: 480 }, facingMode: "user" } });
            video.srcObject = stream; video.style.display = 'block'; cameraActive = true; document.getElementById('toggle-cam-btn').innerText = 'CAM OFF';
            await video.play(); canvas.width = 160; canvas.height = 120;
        } catch(e) { console.error(e); cameraActive = false; document.getElementById('toggle-cam-btn').innerText = 'CAM ON'; }
    }

    async function initGame() {
        bgMusic.currentTime = 0; bgMusic.play().catch(e => console.log("Audio blocked"));
        document.getElementById('start-screen').style.display = 'none';
        document.getElementById('game-container').style.display = 'block';
        document.getElementById('mute-btn').style.display = 'block';
        document.getElementById('early-end-btn').style.display = 'block';
        document.getElementById('toggle-cam-btn').style.display = 'block';
        await startCamera();
        const announcer = document.getElementById('round-announcer'); announcer.style.display = 'block';
        let count = 3; announcer.innerText = count;
        const countInt = setInterval(() => { count--; if (count > 0) announcer.innerText = count; else { clearInterval(countInt); announcer.style.display = 'none'; startGameLogic(); } }, 1000);
    }

    function startGameLogic() { gameActive = true; startRound(1); mainTimer(); updateFrame(); }

    function slash(el) {
        if (el.dataset.hit === "true") return; el.dataset.hit = "true";
        const rect = el.getBoundingClientRect(); createExplosion(rect.left + rect.width/2, rect.top + rect.height/2);
        playSlashSound();
        const charName = el.dataset.name; hitCount[charName] = (hitCount[charName] || 0) + 1;
        if (charName === selectedSlasher) selfKills++;
        const char = characters.find(c => c.name === charName);
        score += char && char.bonus ? 3 : 1; document.getElementById('score-board').innerText = score;
        el.remove();
    }

    function playSlashSound() {
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
        osc.type = 'sawtooth'; osc.frequency.setValueAtTime(450, audioCtx.currentTime);
        osc.frequency.exponentialRampToValueAtTime(40, audioCtx.currentTime + 0.1);
        gain.gain.setValueAtTime(1.0, audioCtx.currentTime); gain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.1);
        osc.connect(gain); gain.connect(audioCtx.destination);
        osc.start(); osc.stop(audioCtx.currentTime + 0.1);
    }

    function mainTimer() { mainInterval = setInterval(() => { if (!gameActive) return; songElapsed++; document.getElementById('timer').innerText = 60 - songElapsed; if (songElapsed === 14) startRound(2); if (songElapsed === 35) startRound(3); if (songElapsed >= 60) finishGame(); }, 1000); }
    function startRound(num) { currentRound = num; spawnRate = 1250 - (num * 300); moveDuration = 4500 - (num * 1000); const ann = document.getElementById('round-announcer'); ann.innerText = `ROUND ${num}`; ann.style.display = 'block'; setTimeout(() => ann.style.display = 'none', 1500); spawnLoop(); }
    function spawnLoop() { if (!gameActive) return; createTarget(); setTimeout(spawnLoop, spawnRate); }
    function finishGame() { gameActive = false; clearInterval(mainInterval); bgMusic.pause(); showEndScreen(); }

    function createTarget() {
        const char = characters[Math.floor(Math.random() * characters.length)]; const t = document.createElement('div');
        t.className = 'target'; t.dataset.name = char.name; t.style.backgroundImage = `url('${char.url}')`;
        t.onmouseenter = () => slash(t); t.onmousedown = () => slash(t); t.ontouchstart = (e) => { e.preventDefault(); slash(t); };
        const sides = [{x:Math.random()*80,y:-15},{x:105,y:Math.random()*80},{x:Math.random()*80,y:105},{x:-15,y:Math.random()*80}];
        const s = sides[Math.floor(Math.random()*4)]; t.style.left = s.x+'%'; t.style.top = s.y+'%';
        document.getElementById('game-container').appendChild(t);
        t.animate([{left:s.x+'%', top:s.y+'%'}, {left:Math.random()*100+'%', top:Math.random()*100+'%'}], {duration:moveDuration}).onfinish = () => { if(t.parentNode) t.remove(); };
    }

    function createExplosion(x, y) {
        for (let i = 0; i < 15; i++) {
            const p = document.createElement('div'); p.className = 'particle';
            p.style.left = x + 'px'; p.style.top = y + 'px'; document.body.appendChild(p);
            const angle = Math.random() * Math.PI * 2, vel = Math.random() * 10 + 5;
            p.animate([{transform: 'translate(0,0) scale(1)', opacity: 1}, {transform: `translate(${Math.cos(angle)*vel*20}px, ${Math.sin(angle)*vel*20}px) scale(0)`, opacity: 0}], {duration: 600}).onfinish = () => p.remove();
        }
    }

    function updateFrame() {
        if (!gameActive || !cameraActive) { requestAnimationFrame(updateFrame); return; }
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height); const cur = ctx.getImageData(0,0,canvas.width,canvas.height).data;
        if (prevFrameData) {
            document.querySelectorAll('.target').forEach(t => {
                const rect = t.getBoundingClientRect();
                const tx = Math.floor((1 - (rect.left + rect.width / 2) / window.innerWidth) * canvas.width);
                const ty = Math.floor((rect.top + rect.height / 2) / window.innerHeight * canvas.height);
                if (checkMotion(tx, ty, cur, prevFrameData)) slash(t);
            });
        }
        prevFrameData = cur; requestAnimationFrame(updateFrame);
    }

    function checkMotion(x,y,cur,prev) { let diff = 0; const r = 10; for(let i=x-r; i<x+r; i+=2) { for(let j=y-r; j<y+r; j+=2) { if(i<0 || i>=canvas.width || j<0 || j>=canvas.height) continue; const idx = (j*canvas.width+i)*4; if(Math.abs(cur[idx]-prev[idx])>25) diff++; } } return diff > 8; }

    function showEndScreen() {
        document.getElementById('game-container').style.display = 'none';
        document.querySelectorAll('.side-btn').forEach(b => b.style.display = 'none');
        document.getElementById('end-screen').style.display = 'flex';
        let mostHitName = Object.keys(hitCount).reduce((a, b) => hitCount[a] > hitCount[b] ? a : b, characters[0].name);
        let charData = characters.find(c => c.name === mostHitName);
        document.getElementById('most-hit-img').style.backgroundImage = `url('${charData.url}')`;
        document.getElementById('most-hit-text').innerHTML = `I Guess You Really Like This one..<br>You hit him ${hitCount[mostHitName] || 0} times!`;
        document.getElementById('self-kill-text').innerText = `You also Killed Yourself ${selfKills} times ha ha ha`;
        document.getElementById('final-total-score').innerText = `Total Score: ${score}`;
        document.getElementById('whatsapp-share').onclick = () => { window.open(`https://api.whatsapp.com/send?text=${encodeURIComponent(`I scored ${score} points on BX SLASHERS!  I even killed myself ${selfKills} times! Beat me here: ${gameUrl}`)}`, '_blank'); };
    }

    function renderCharacterRow() {
        const row = document.getElementById('character-row'); row.innerHTML = '';
        characters.forEach((char, idx) => {
            const div = document.createElement('div'); div.className = 'char-preview' + (char.name === selectedSlasher ? ' selected' : '');
            div.style.backgroundImage = `url('${char.url}')`;
            div.onclick = () => { selectedSlasher = char.name; renderCharacterRow(); };
            const del = document.createElement('button'); del.className = 'delete-btn'; del.innerText = '';
            del.onclick = (e) => { e.stopPropagation(); characters.splice(idx,1); renderCharacterRow(); };
            div.appendChild(del); row.appendChild(div);
        });
    }

    function saveNewCharacter() {
        const name = document.getElementById('new-name').value; const file = document.getElementById('new-file').files[0];
        if(!name || !file) return;
        const reader = new FileReader();
        reader.onload = (e) => { characters.push({name: name, url: e.target.result, bonus: false}); renderCharacterRow(); document.getElementById('upload-modal').style.display = 'none'; };
        reader.readAsDataURL(file);
    }

    window.onload = renderCharacterRow;
    document.getElementById('start-button').onclick = initGame;
    document.getElementById('mute-btn').onclick = () => { bgMusic.muted = !bgMusic.muted; document.getElementById('mute-btn').innerText = bgMusic.muted ? "" : ""; };
    document.getElementById('early-end-btn').onclick = finishGame;
</script>
</body>
</html>
