<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>BX SLASHERS - HAND TRACKING</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>

    <style>
        body, html { 
            margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; 
            background-color: #000; font-family: 'Arial Black', sans-serif; color: white; 
            text-align: center; touch-action: none; 
        }
        
        /* ×¨×§×¢ ×“×¡×§×˜×•×¤ */
        #fallback-bg { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: url('bg.png') no-repeat center top; 
            background-size: cover; z-index: 1; display: block; 
        }

        /* ××œ×× ×˜ ×”×•×™×“××• ×”× ×¡×ª×¨ ×©×œ ×”××¦×œ××” */
        #input-video { display: none; }
        
        /* ×¡××Ÿ ×”×™×“ ×”×•×•×™×¨×˜×•××œ×™ */
        #hand-cursor {
            position: fixed; width: 40px; height: 40px; background: rgba(255, 0, 0, 0.6);
            border: 3px solid white; border-radius: 50%; pointer-events: none;
            z-index: 9999; display: none; box-shadow: 0 0 15px #ff0000;
        }

        #game-container { position: relative; width: 100vw; height: 100vh; z-index: 10; display: none; }
        
        /* ××¡×š ×¤×ª×™×—×” */
        #start-screen { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(17, 17, 17, 0.9); display: flex; flex-direction: column; 
            justify-content: center; align-items: center; z-index: 2000; padding: 20px; box-sizing: border-box; 
        }
        
        #main-title { font-size: 85px; color: #ff0000; text-shadow: 5px 5px #fff; margin: 0; text-transform: uppercase; }
        #sub-title { font-size: 28px; color: #fff; margin: 15px 0 10px 0; }
        
        /* ×‘×•×¨×¨ ××¦×‘ ××¦×œ××” */
        .camera-selector {
            margin: 20px 0;
            background: rgba(255, 0, 0, 0.2);
            padding: 15px 30px;
            border-radius: 50px;
            border: 2px solid #ff0000;
            cursor: pointer;
            transition: 0.3s;
        }
        .camera-selector:hover { background: rgba(255, 0, 0, 0.4); }
        .camera-selector input { cursor: pointer; transform: scale(1.5); margin-right: 15px; }
        .camera-selector label { font-size: 20px; cursor: pointer; color: white; font-weight: bold; }

        #character-row { display: flex; justify-content: center; gap: 12px; width: 95%; overflow-x: auto; padding: 15px; margin-bottom: 20px; }
        .char-preview { width: 65px; height: 65px; border-radius: 50%; background-size: cover; border: 3px solid #fff; flex-shrink: 0; cursor: pointer; transition: 0.2s; }
        .char-preview.selected { border: 5px solid #00ff00 !important; transform: scale(1.2); box-shadow: 0 0 20px #00ff00; }
        
        .main-btn { padding: 18px 45px; font-size: 26px; cursor: pointer; color: white; border: none; border-radius: 15px; font-weight: bold; background: #ff0000; box-shadow: 0 0 25px #ff0000; text-transform: uppercase; }
        
        .side-btn { position: fixed; z-index: 3000; background: rgba(0,0,0,0.7); border: 2px solid white; color: white; cursor: pointer; font-weight: bold; border-radius: 50%; width: 50px; height: 50px; font-size: 20px; }
        #mute-btn { top: 20px; right: 20px; }
        #pause-btn { top: 20px; right: 80px; }
        #early-end-btn { top: 20px; left: 20px; border-radius: 10px; padding: 10px 15px; width: auto; font-size: 14px; }
        
        .target { position: absolute; width: 115px; height: 115px; border-radius: 50%; background-size: cover; border: 4px solid white; z-index: 20; }
        #round-announcer { position: absolute; top: 45%; left: 50%; transform: translate(-50%, -50%); font-size: 130px; color: #ff0000; z-index: 500; display: none; text-shadow: 0 0 30px black; font-weight: bold; width: 100%; }

        .stat-box { font-size: 20px; background: rgba(0,0,0,0.85); padding: 10px 20px; border-radius: 15px; border: 2px solid #ff0000; min-width: 120px; }

        @media (max-width: 768px) {
            body { background: url('bg_mobile.jpg') no-repeat center center fixed !important; background-size: cover !important; }
            #fallback-bg { display: none !important; }
            #main-title { font-size: 50px; }
            #sub-title { font-size: 18px; }
            #round-announcer { font-size: 90px; }
            .target { width: 85px; height: 85px; }
            #ui-layer { bottom: 120px !important; }
            .stat-box { font-size: 14px !important; min-width: 90px; }
        }

        .laugh-row { display: block; margin-top: 10px; font-size: 26px; color: #ff0000; text-shadow: 2px 2px #000; }
    </style>
</head>
<body id="body-el">

<video id="input-video"></video>
<div id="hand-cursor"></div>
<audio id="bg-music" src="Final Girl Glitch.mp3" preload="auto" loop></audio>
<div id="fallback-bg"></div>

<button id="mute-btn" class="side-btn" style="display:none;">ğŸ”Š</button>
<button id="pause-btn" class="side-btn" style="display:none;">â¸</button>
<button id="early-end-btn" class="side-btn" style="display:none;">END GAME</button>

<div id="start-screen">
    <h1 id="main-title">BX SLASHERS</h1>
    <h2 id="sub-title">CHOOSE YOUR SLASHER</h2>
    
    <div class="camera-selector" onclick="document.getElementById('camera-toggle').click()">
        <label>
            <input type="checkbox" id="camera-toggle" onclick="event.stopPropagation()"> ğŸ“· ×”×¤×¢×œ ××¦×œ××” (××©×—×§ ×¢× ×”×™×“×™×™×)
        </label>
    </div>

    <div id="character-row"></div>
    <button id="start-button" class="main-btn">START GAME</button>
</div>

<div id="game-container">
    <div id="ui-layer" style="position: absolute; bottom: 40px; width: 100%; display: flex; justify-content: center; gap: 30px; z-index: 100; pointer-events: none;">
        <div class="stat-box">Score: <span id="score-board">0</span></div>
        <div class="stat-box">Time: <span id="timer">60</span></div>
    </div>
</div>

<div id="end-screen" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 4000;">
    <h1 style="font-size: 50px; color: #ff0000;">BX SLASHERS</h1>
    <div id="most-hit-img" style="width: 150px; height: 150px; border-radius: 50%; border: 6px solid #ff0000; background-size: cover;"></div>
    <p id="most-hit-text" style="font-size: 20px; color: #ddd;"></p>
    <div id="self-kill-container">
        <p id="self-kill-text" style="font-size: 22px; color: #ff0000; font-weight: bold; margin: 10px 0;"></p>
    </div>
    <h2 id="final-total-score" style="font-size: 32px; color: #fff;"></h2>
    <button onclick="location.reload()" class="main-btn">PLAY AGAIN</button>
</div>

<script>
    const videoElement = document.getElementById('input-video');
    const handCursor = document.getElementById('hand-cursor');
    const cameraToggle = document.getElementById('camera-toggle');
    const bgMusic = document.getElementById('bg-music');
    let useCamera = false;

    let characters = [{name:'ella', url:'ella.png', bonus:true}, {name:'amir', url:'amir.png', bonus:false}, {name:'elad', url:'elad.png', bonus:true}, {name:'shay', url:'shay.png', bonus:false}, {name:'achinoam', url:'achinoam.png', bonus:false}, {name:'einat', url:'einat.png', bonus:false}, {name:'doron', url:'doron.png', bonus:true}, {name:'hadas', url:'hadas.png', bonus:false}, {name:'adi', url:'adi.png', bonus:true}, {name:'idan', url:'idan.png', bonus:true}, {name:'shoval', url:'shoval.png', bonus:false}, {name:'stas', url:'stas.png', bonus:false}, {name:'vik', url:'vik.png', bonus:false}, {name:'vivi', url:'vivi.png', bonus:false}];
    
    let hitCount = {}; let score = 0, songElapsed = 0, gameActive = false, isPaused = false, selectedSlasher = 'amir', selfKills = 0;
    let mainInterval, spawnLoopTimeout;

    // ×”×’×“×¨×•×ª MediaPipe Hands
    const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
    hands.setOptions({ maxNumHands: 1, modelComplexity: 1, minDetectionConfidence: 0.6, minTrackingConfidence: 0.6 });

    hands.onResults((results) => {
        if (!gameActive || isPaused || !results.multiHandLandmarks.length) {
            handCursor.style.display = 'none';
            return;
        }
        
        handCursor.style.display = 'block';
        const hand = results.multiHandLandmarks[0];
        const indexFinger = hand[8]; // ×§×¦×” ×”××¦×‘×¢ ×”××•×¨×”
        
        const x = (1 - indexFinger.x) * window.innerWidth; // ××¨××”
        const y = indexFinger.y * window.innerHeight;

        handCursor.style.left = x + 'px';
        handCursor.style.top = y + 'px';

        checkHandCollision(x, y);
    });

    function checkHandCollision(x, y) {
        const targets = document.querySelectorAll('.target');
        targets.forEach(t => {
            const rect = t.getBoundingClientRect();
            if (x > rect.left && x < rect.right && y > rect.top && y < rect.bottom) {
                slash(t);
            }
        });
    }

    const cameraInstance = new Camera(videoElement, {
        onFrame: async () => { if(useCamera) await hands.send({image: videoElement}); },
        width: 1280, height: 720
    });

    async function initGame() {
        useCamera = cameraToggle.checked;
        
        if (useCamera) {
            try {
                await cameraInstance.start();
            } catch (err) {
                console.error("Camera error:", err);
                alert("×œ× × ×™×ª×Ÿ ×”×™×” ×œ×”×¤×¢×™×œ ××ª ×”××¦×œ××”. ×”××©×—×§ ×™×ª×—×™×œ ×‘××¦×‘ ×¢×›×‘×¨.");
                useCamera = false;
            }
        }

        bgMusic.play().catch(e => console.log("Audio blocked"));
        document.getElementById('start-screen').style.display = 'none';
        document.getElementById('game-container').style.display = 'block';
        document.querySelectorAll('.side-btn').forEach(b => b.style.display = 'block');

        const announcer = document.getElementById('round-announcer'); 
        announcer.style.display = 'block';
        let count = 3; 
        announcer.innerText = count;
        
        const countInt = setInterval(() => { 
            if (isPaused) return;
            count--; 
            if (count > 0) announcer.innerText = count; 
            else { 
                clearInterval(countInt); 
                announcer.style.display = 'none'; 
                gameActive = true; 
                startRound(1); 
                mainTimer(); 
            } 
        }, 1000);
    }

    function slash(el) {
        if (el.dataset.hit === "true") return;
        el.dataset.hit = "true";
        const rect = el.getBoundingClientRect();
        createExplosion(rect.left + rect.width/2, rect.top + rect.height/2);
        playSlashSound();
        
        const charName = el.dataset.name;
        hitCount[charName] = (hitCount[charName] || 0) + 1;
        if (charName === selectedSlasher) selfKills++;
        
        const char = characters.find(c => c.name === charName);
        score += char && char.bonus ? 3 : 1;
        document.getElementById('score-board').innerText = score;
        el.remove();
    }

    function startRound(num) { 
        const spawnRate = 1250 - (num * 300); 
        const ann = document.getElementById('round-announcer'); 
        ann.innerText = `ROUND ${num}`; 
        ann.style.display = 'block'; 
        setTimeout(() => ann.style.display = 'none', 1500); 
        
        const loop = () => {
            if (!gameActive) return;
            if (!isPaused) createTarget(4500 - (num * 1000));
            spawnLoopTimeout = setTimeout(loop, spawnRate);
        };
        loop();
    }

    function createTarget(duration) {
        const char = characters[Math.floor(Math.random() * characters.length)];
        const t = document.createElement('div');
        t.className = 'target';
        t.dataset.name = char.name;
        t.style.backgroundImage = `url('${char.url}')`;
        
        t.onmousedown = () => slash(t);
        t.ontouchstart = (e) => { e.preventDefault(); slash(t); };

        const sides = [{x:Math.random()*80,y:-15},{x:105,y:Math.random()*80},{x:Math.random()*80,y:105},{x:-15,y:Math.random()*80}];
        const s = sides[Math.floor(Math.random()*4)];
        t.style.left = s.x+'%'; t.style.top = s.y+'%';
        document.getElementById('game-container').appendChild(t);
        
        const anim = t.animate([
            {left:s.x+'%', top:s.y+'%'}, 
            {left:Math.random()*100+'%', top:Math.random()*100+'%'}
        ], {duration: duration});
        
        anim.onfinish = () => { if(t.parentNode) t.remove(); };
    }

    function mainTimer() { 
        mainInterval = setInterval(() => { 
            if (!gameActive || isPaused) return; 
            songElapsed++; 
            document.getElementById('timer').innerText = 60 - songElapsed; 
            if (songElapsed === 14) startRound(2); 
            if (songElapsed === 35) startRound(3); 
            if (songElapsed >= 60) finishGame(); 
        }, 1000); 
    }

    function finishGame() {
        gameActive = false;
        clearInterval(mainInterval);
        clearTimeout(spawnLoopTimeout);
        bgMusic.pause();
        showEndScreen();
    }

    function showEndScreen() {
        document.getElementById('game-container').style.display = 'none';
        document.querySelectorAll('.side-btn').forEach(b => b.style.display = 'none');
        document.getElementById('end-screen').style.display = 'flex';
        let mostHitName = Object.keys(hitCount).reduce((a, b) => hitCount[a] > hitCount[b] ? a : b, characters[0].name);
        document.getElementById('most-hit-img').style.backgroundImage = `url('${characters.find(c => c.name === mostHitName).url}')`;
        document.getElementById('most-hit-text').innerHTML = `I Guess You Really Like This Person..<br>You hit them ${hitCount[mostHitName] || 0} times!`;
        document.getElementById('self-kill-text').innerHTML = `You also Killed Yourself ${selfKills} times <div class="laugh-row">ha ha ha</div>`;
        document.getElementById('final-total-score').innerText = `Total Score: ${score}`;
    }

    function playSlashSound() {
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
        osc.type = 'sawtooth'; osc.frequency.setValueAtTime(450, audioCtx.currentTime);
        osc.frequency.exponentialRampToValueAtTime(40, audioCtx.currentTime + 0.1);
        gain.gain.setValueAtTime(0.5, audioCtx.currentTime); gain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.1);
        osc.connect(gain); gain.connect(audioCtx.destination);
        osc.start(); osc.stop(audioCtx.currentTime + 0.1);
    }

    function createExplosion(x, y) {
        for (let i = 0; i < 15; i++) {
            const p = document.createElement('div');
            p.style.cssText = `position:absolute; width:8px; height:8px; background:#f00; left:${x}px; top:${y}px; pointer-events:none; z-index:100;`;
            document.body.appendChild(p);
            const angle = Math.random() * Math.PI * 2, vel = Math.random() * 10 + 5;
            p.animate([{transform: 'translate(0,0) scale(1)', opacity: 1}, {transform: `translate(${Math.cos(angle)*vel*20}px, ${Math.sin(angle)*vel*20}px) scale(0)`, opacity: 0}], {duration: 600}).onfinish = () => p.remove();
        }
    }

    function togglePause() {
        isPaused = !isPaused;
        if (isPaused) {
            bgMusic.pause();
            document.querySelectorAll('.target').forEach(t => t.getAnimations().forEach(a => a.pause()));
        } else {
            bgMusic.play();
            document.querySelectorAll('.target').forEach(t => t.getAnimations().forEach(a => a.play()));
        }
    }

    function renderCharacterRow() {
        const row = document.getElementById('character-row');
        row.innerHTML = '';
        characters.forEach((char) => {
            const div = document.createElement('div');
            div.className = 'char-preview' + (char.name === selectedSlasher ? ' selected' : '');
            div.style.backgroundImage = `url('${char.url}')`;
            div.onclick = () => { selectedSlasher = char.name; renderCharacterRow(); };
            row.appendChild(div);
        });
    }

    window.onload = renderCharacterRow;
    document.getElementById('start-button').onclick = initGame;
    document.getElementById('mute-btn').onclick = () => { bgMusic.muted = !bgMusic.muted; };
    document.getElementById('pause-btn').onclick = togglePause;
    document.getElementById('early-end-btn').onclick = finishGame;
</script>
</body>
</html>
